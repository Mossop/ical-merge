#!/bin/bash
set -euo pipefail

# Check argument
if [ $# -ne 1 ]; then
    echo "Usage: $0 <major|minor|patch>"
    exit 1
fi

BUMP_TYPE="$1"

if [[ ! "$BUMP_TYPE" =~ ^(major|minor|patch)$ ]]; then
    echo "Error: Invalid bump type. Must be major, minor, or patch"
    exit 1
fi

# Check for pending changes
if jj log -r '@ & ~empty()' --no-pager 2>/dev/null | grep -q .; then
    echo "Error: You have pending changes in the current revision"
    echo "Please commit your changes before creating a release"
    exit 1
fi

# Extract current version from Cargo.toml
CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

if [ -z "$CURRENT_VERSION" ]; then
    echo "Error: Could not extract version from Cargo.toml"
    exit 1
fi

echo "Current version: $CURRENT_VERSION"

# Parse version components
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Bump version based on type
case "$BUMP_TYPE" in
    major)
        MAJOR=$((MAJOR + 1))
        MINOR=0
        PATCH=0
        ;;
    minor)
        MINOR=$((MINOR + 1))
        PATCH=0
        ;;
    patch)
        PATCH=$((PATCH + 1))
        ;;
esac

NEW_VERSION="$MAJOR.$MINOR.$PATCH"
echo "New version: $NEW_VERSION"

# Update Cargo.toml
sed -i '' "s/^version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" Cargo.toml

# Update Cargo.lock
cargo check --quiet

# Commit with jj
jj commit -m "Update version to $NEW_VERSION"

# Tag the previous revision
jj tag set -r @- "v$NEW_VERSION"

echo "✓ Version bumped to $NEW_VERSION"
echo "✓ Committed and tagged as v$NEW_VERSION"
echo ""
echo "To push the tag to remote, run:"
echo "  jj git push && git push --tags"
